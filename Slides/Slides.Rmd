---
title: |
       ![](Slides_files/RUB.jpg){width=2.5in}
subtitle:  "Workshop: Data Wrangling of Web Data in R"
author: "Simon Ress | Ruhr-Universität Bochum"
#institute: "Conference: 56. Jahrestagung der DGSMP, Leipzig, 2021"
date: "October 18, 2021"

output:
  beamer_presentation:
    keep_md: true
    keep_tex: no
    latex_engine: xelatex
    #theme: metropolis
    slide_level: 3 # which header level should be printed as slides
    incremental: no
header-includes:
#Choose numbering format
  - \usetheme[numbering=fraction]{metropolis}
#Define footer:
  - \definecolor{beaublue}{rgb}{0.74, 0.83, 0.9}
  - \setbeamertemplate{frame footer}{\tiny{\textcolor{beaublue}{Workshop - Data Wrangling of Web Data in R | SIMON RESS}}}
#hide footer on title page:
  - |
    \makeatletter
    \def\ps@titlepage{%
      \setbeamertemplate{footline}{}
    }
    \addtobeamertemplate{title page}{\thispagestyle{titlepage}}{}
    \makeatother
#show footer on section's start/title pages:
  #overwrite "plain,c,noframenumbering" in section pages definition -> enables footer:
  - |
    \makeatletter
    \renewcommand{\metropolis@enablesectionpage}{
      \AtBeginSection{
        \ifbeamer@inframe
          \sectionpage
        \else
          \frame[c]{\sectionpage}
        \fi
      }
    }
    \metropolis@enablesectionpage
    \makeatother
  #define footer of section pages:
  - |
    \makeatletter
    \def\ps@sectionpage{%
      \setbeamertemplate{frame footer}{\tiny{\textcolor{beaublue}{Workshop - Data Wrangling of Web Data in R | SIMON RESS}}}
    }
    \addtobeamertemplate{section page}{\thispagestyle{sectionpage}}{}
    \makeatother
#add section numbers to TOC:
  - |
    \setbeamertemplate{section in toc}{
    \leavevmode%
    \inserttocsectionnumber. 
    \inserttocsection\par%
    }
    \setbeamertemplate{subsection in toc}{
    \leavevmode\leftskip=2.5em\inserttocsubsection\par}
#Adjust representation of chunks
  #Reduce space between code chunks and code output
  - |
    \setlength{\OuterFrameSep}{-4pt}
    \makeatletter
    \preto{\@verbatim}{\topsep=-10pt \partopsep=-10pt }
    \makeatother
  #Change background-color of source-code
  - \definecolor{shadecolor}{RGB}{240,240,240}
  #Set a frame around the results
  - | 
    \let\verbatim\undefined
    \let\verbatimend\undefined
    \DefineVerbatimEnvironment{verbatim}{Verbatim}{frame=single, rulecolor=\color{shadecolor}, framerule=0.3mm,framesep=1mm}
#enable line breaks in chunks
  - |
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
#   \DefineVerbatimEnvironment{verbatim}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
if(!require("tidyverse")) install.packages("tidyverse") 
  library(tidyverse) # for fill() 
if(!require("formatR")) install.packages("formatR")
  library(formatR)
if(!require("styler")) install.packages("styler")
  library(styler)
library(knitr)
knitr::opts_chunk$set(echo = T,
                      eval = T)
                      #tidy=TRUE, 
                      #tidy.opts=list(width.cutoff=60))
```

### Content
\tableofcontents[]

# Setup

### Target

**Meta information**

- Finanzausschuss
- Ausschüsse der 19. Wahlperiode (2017-2021)
- Öffentliche Anhörungen

URL: https://www.bundestag.de/webarchiv/Ausschuesse/ausschuesse19/a07/Anhoerungen

**Unit information** 

- Committees

URL: Needs to be scraped from main page


### Configurate & Start Selenium/Browser

```{r Selenium-install, include=F}
if(!require("tidyverse")) require(tidyverse) 
  library(tidyverse) # for fill() 
if(!require("stringr")) install.packages("stringr")
  library(stringr) # for str_detect()
if(!require("RSelenium")) install.packages("RSelenium")
if(!require("rvest")) install.packages("rvest")
```

```{r Selenium, results='hide', message=F, warning=F}
library(RSelenium)
library(rvest) #for read_html(), html_elements()...
#Free all ports
  system("taskkill /im java.exe /f", intern=FALSE, ignore.stdout=FALSE)
#Start a selenium & Assign client to an R-object  
  rD <- rsDriver(port = 4561L, browser = "firefox")
  remDr <- rD[["client"]]
  #remDr$quit
```



# Functions

### Overview

- Functions are **blocks of codes** which can be executed repeatedly by calling them
- **Parameters** (data) can be passed into them, which are used by the code inside
- **Data can be returned** from a function

*Syntax:*
```{r functions, eval=F}
function_name <- function(arg_1, arg_2, ...) {
     Function body 
}
```

### Function Components
The four parts of a function are:

- **Function Name:** This is the actual name of the function. It is stored in R environment as an object with this name.
- **Arguments (*optional*):** An argument is a placeholder. When a function is invoked, you pass a value to the argument. Arguments *can* have default values.
- **Function Body:** The function body contains a collection of statements that defines what the function does.
- **Return Value:** The return value of a function is the last expression in the function body to be evaluated.

### Examplary Function 

```{r examplary_function}
square <- function(value = 1, factor = 1) {
     return(value^factor)
}
square() #use defaut args
square(2,3) #use args by position
square(factor=2, value=5) #use args by name
```



### Define savepage()

```{r define_savepage}
#Load url & return content as r-object 
  savepage <- function(url){
    #Navigate to starting page
      remDr$navigate(url)
    #Wait until page is loaded  
      Sys.sleep(abs(rnorm(1, 2, 1)))
    #Save content to an R-object
      remDr$getPageSource(header = TRUE)[[1]] %>%  
        read_html() %>% 
        return()
  }
```
*Note: [[1]] behinde getPageSource() unlist the output -> makes it searchable*


### Usage of savepage()
```{r use_savepage-print, eval=F}
#navigate to url & save content as r-object
page <- savepage("https://www.bundestag.de/ webarchiv/Ausschuesse/ausschuesse19/a07/ Anhoerungen")
page
```

```{r use_savepage-eval, echo=F, results='markup'}
#navigate to url & save content as r-object 
page <- savepage("https://www.bundestag.de/webarchiv/Ausschuesse/ausschuesse19/a07/Anhoerungen")
page
```

# Iteration: Loops & Apply-family

### Overview

- Often specific tasts needs to be executed multiple times
- This iteration can be performed using loops or functions from the apply family

Example:
```{r example-iterations}
mean(iris$Sepal.Length)
mean(iris$Sepal.Width)
mean(iris$Petal.Length)
mean(iris$Petal.Width)
```


### for-loop
- A for loop is used for iterating over a sequence:
- With the break statement, we can stop the loop before it has looped through all the items:
- With the next statement, we can skip an iteration without terminating the loop:

```{r for-basic}
for (x in names(iris)) {
  print(mean(iris[,x]))
}
```

### for-loop: break
*Breaking* the loop at certain conditions
```{r for-break}
for (x in cars$dist) {
  if (x > 20)  break
  print(x)
}
```

### for-loop: next
*Skip* the code below and start over at certain conditions
```{r for-next}
fruits <- list("apple", "banana", "cherry")

for (x in fruits) {
  if (x == "banana") next
  print(x)
}
```

### while-loop
- Execute a set of statements as long as a condition is TRUE
- *break* statement stops the loop even if the while condition is TRUE:
- *next* statement skips an iteration without terminating the loop:

```{r while-Basic}
i <- 0
while (i < 20) {
  i <- i + 1
  print(i)
}
```

### while-loop: break
*Breaking* the loop at certain conditions
```{r while-break}
i <- 0
while (i < 20) {
  i <- i + 1
  if (i == 5) break
  print(i)
}
```

### while-loop: next
*Skip* the code below and start over at certain conditions
```{r while-next}
i <- 0
while (i < 10) {
  i <- i + 1
  if (i %% 2) next
  print(i)
}
```

### apply-family

- The apply in R function can be feed with many functions to perform redundant application on a collection of object (data frame, list, vector, etc.). 
- The purpose of apply() is primarily to avoid explicit uses of loop constructs. 
- Any function can be passed into

### Main apply functions
\fontsize{8}{10}\selectfont
| Function        | Arguments                | Objective                                              | Input                      | Output              |
|-----------------|--------------------------|--------------------------------------------------------|----------------------------|---------------------|
| apply           | apply(x, MARGIN, FUN)    | Apply a function to the rows or columns or both        | Data frame or matrix       | vector, list, array |
| lapply <br> (list)   | lapply(X, FUN)           | Apply a function to all the elements of the input      | List, vector or data frame | list                |
| sapply <br> (simple) | sapply(X, FUN)           | Apply a function to all the elements of the input      | List, vector or data frame | vector or matrix    |
| tapply <br> (tagged) | tapply(X, grouping, FUN) | Apply a function for each factor variable in an vector | Vector                     | matrix or array     |


### apply()-usage
apply(x, MARGIN, FUN)

```{r apply}
m1 <- matrix(C<-(1:10),nrow=4, ncol=4)
m1
apply(m1, 1, sum) #1=by row
apply(m1, 2, sum) #2=by column
```

### lapply()-usage
lapply(X, FUN)

```{r lapply}
lapply(cars, mean)
```

### sapply()-usage
sapply(X, FUN)

```{r lapply}
sapply(1:4, print)
```

### tapply()-usage
tapply(X, grouping, FUN)
```{r tapply}
tapply(iris$Sepal.Length , list(iris$Species), mean)
```

Similar to tapply() is aggregate() which returns a data frame
```{r aggregate}
aggregate(iris$Sepal.Length , list(iris$Species), mean)
```



# Dplyr - Gramma of Data Manipulation

### Overview


# Purr

### Overview
"purrr enhances R’s functional programming (FP) toolkit by providing a complete and consistent set of tools for working with functions and vectors."

```{r map}
if(!require("purrr")) install.packages("purrr") 
  library(purrr) # for fill() 
mtcars %>%
  split(.$cyl) %>% # from base R
  map(~ lm(mpg ~ wt, data = .)) %>%
  map(summary) %>%
  map_dbl("r.squared")
```

# Helpful Sources
- [purr: Overview](https://purrr.tidyverse.org/)
- [purr: References](https://purrr.tidyverse.org/reference/index.html)
- [purr: Cheatsheet](https://github.com/rstudio/cheatsheets/blob/master/purrr.pdf)





# Helpful sources

- [Stringr: Overview](https://stringr.tidyverse.org/)
- [Stringr: Introduction](https://cloud.r-project.org/web/packages/stringr/vignettes/stringr.html)
- [Stringr: Cheatsheet](https://github.com/rstudio/cheatsheets/blob/master/strings.pdf)
- [Stringr: Reference manual](https://cloud.r-project.org/web/packages/stringr/stringr.pdf)
- [Base R String-functions vs Stringr](https://stringr.tidyverse.org/articles/from-base.html)
- [Working with strings in R](https://r4ds.had.co.nz/strings.html)
- [Regular expressions](https://cloud.r-project.org/web/packages/stringr/vignettes/regular-expressions.html)
- [Primary R functions for dealing with regular expressions](https://bookdown.org/rdpeng/rprogdatascience/regular-expressions.html)


### References
All graphics are taken from [String manipulaton with stringr Cheatsheet](https://github.com/rstudio/cheatsheets/blob/master/strings.pdf)